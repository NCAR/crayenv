#!/bin/bash

GTIDS=$(echo $SLURM_GTIDS|sed -e 's/,/ /g')
GTIDMIN=$(printf "%d\n" $GTIDS|sort -n|head -1)
MYGTID=$SLURM_PROCID
NCPUNODE=$SLURM_CPUS_ON_NODE
MYLTID=$(( SLURM_PROCID - GTIDMIN ))
NTNODE=$(echo $GTIDS|wc -w)
TSKNTHD=$(( NTNODE * OMP_NUM_THREADS ))
XTRACPU=$(( NCPUNODE - TSKNTHD  ))
OFFST=$(( XTRACPU / 2 ))
CPUSPTASK=$(( ( NCPUNODE - XTRACPU ) / NTNODE ))
MYCPUBEG=$(( OFFST + MYLTID * CPUSPTASK ))
MYCPUEND=$(( MYCPUBEG + CPUSPTASK - 1 ))
MYCPUINT=$(( CPUSPTASK / OMP_NUM_THREADS ))

export GOMP_CPU_AFFINITY="${MYCPUBEG}-${MYCPUEND}:${MYCPUINT}"
numactl -C "${MYCPUBEG}-${MYCPUEND}" $@
