#!/bin/bash

GTIDS=$(echo $SLURM_GTIDS|sed -e 's/,/ /g')
GTIDMIN=$(printf "%d\n" $GTIDS|sort -n|head -1)
MYGTID=$SLURM_PROCID
NCPUNODE=$SLURM_CPUS_ON_NODE
MYLTID=$(( SLURM_PROCID - GTIDMIN ))
NTNODE=$(echo $GTIDS|wc -w)
CPUSPTASK=$(( NCPUNODE / NTNODE ))
MYCPUBEG=$(( MYLTID * CPUSPTASK ))
MYCPUEND=$(( MYCPUBEG + CPUSPTASK - 1 ))
MYCPUINT=$(( CPUSPTASK / OMP_NUM_THREADS ))

export GOMP_CPU_AFFINITY="${MYCPUBEG}-${MYCPUEND}:${MYCPUINT}"
numactl -C "${MYCPUBEG}-${MYCPUEND}" $@
