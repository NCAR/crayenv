#!/bin/bash
#
# This script expects 2 environment variables
#   1. CENV_CCPREF    - The location where to pick charlie-cloud launcher ch-run
#   2. CENV_IMAGEROOT - The root of Image Sandbox for Charlie cloud
#

ALLARGS="$@"
NARGS=$#
me=$(whoami)
BASH="/bin/bash"
wd=$(pwd)

source /etc/profile.d/modules.sh
ml purge
unset MODULEPATH_ROOT
unset MODULEPATH
unset MODULESHOME
unset -f module
unset -f ml

if [ ! -z "$PBS_JOBID" ] ; then
    SCRDIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
    ${SCRDIR}/start_slurm.sh < /dev/null
fi

shargs="--rcfile /root/.bashenv"

if [ $NARGS -eq 0 ] ; then
   ${CENV_CCPREF}/ch-run -b/glade:/glade -b/tmp:/tmp --cd=${wd} \
    --set-env=${CENV_IMAGEROOT}/ch/environment ${CENV_IMAGEROOT} -- ${BASH} ${shargs}
else
   ${CENV_CCPREF}/ch-run -b/glade:/glade -b/tmp:/tmp --cd=${wd} \
    --set-env=${CENV_IMAGEROOT}/ch/environment ${CENV_IMAGEROOT} -- ${BASH} -c "${ALLARGS}"
fi
