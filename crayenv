#!/bin/bash
#
# This script expects 2 environment variables
#   1. CENV_CCPREF    - The location where to pick charlie-cloud launcher ch-run
#   2. CENV_IMAGEROOT - The root of Image Sandbox for Charlie cloud
#

ALLARGS="$@"
NARGS=$#
me=$(whoami)
BASH="/bin/bash"
wd=$(pwd)

LOGFIL="/glade/scratch/csgteam/logs/cpe/${me}.$(hostname -s).$$"
echo "Started: $(date +'%Y-%m-%dT%H:%M:%S')" > ${LOGFIL}

export SCR_CCPREF=${CENV_CCPREF}
export SCR_IMAGEROOT=${CENV_IMAGEROOT}

source /etc/profile.d/modules.sh
ml purge
unset MODULEPATH_ROOT
unset MODULEPATH
unset MODULESHOME
unset -f module
unset -f ml

if [ ! -z "$PBS_JOBID" ] ; then
    SCRDIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
    ${SCRDIR}/start_slurm.sh < /dev/null
fi

shargs="--rcfile /root/.bashenv"

if [ $NARGS -eq 0 ] ; then
   ${SCR_CCPREF}/ch-run -b/glade:/glade -b/tmp:/tmp --cd=${wd} \
    --set-env=${SCR_IMAGEROOT}/ch/environment ${SCR_IMAGEROOT} -- ${BASH} ${shargs}
else
   ${SCR_CCPREF}/ch-run -b/glade:/glade -b/tmp:/tmp --cd=${wd} \
    --set-env=${SCR_IMAGEROOT}/ch/environment ${SCR_IMAGEROOT} -- ${BASH} -c "${ALLARGS}"
fi
echo "Ended: $(date +'%Y-%m-%dT%H:%M:%S')" >> ${LOGFIL}
