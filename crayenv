#!/bin/bash
#
# This script expects 1 environment variable
#   1. SENV_IMAGEROOT - The root of Image Sandbox for Singularity
#
# -- Need to get rid of this in production
export SENV_IMAGEROOT=/glade/u/apps/ch/opt/hpe-cpe/21.09/cray_hpe_cpe_21.09-101921

ALLARGS=" $@ "
NARGS=$#
me=$(whoami)
THESHELL="/bin/bash"

LOGFIL="/glade/scratch/csgteam/logs/cpe/${me}.$(hostname -s).$$"
echo "Started: $(date +'%Y-%m-%dT%H:%M:%S')" > ${LOGFIL}

source /etc/profile.d/modules.sh
ml singularity
SCRDIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
export SINGULARITY=$(which singularity)
export SCR_IMAGEROOT=${SENV_IMAGEROOT}
export SINGULARITYENV_OMP_NUM_THREADS=$OMP_NUM_THREADS
export STARTUPENV=${SCRDIR}/startupenv
export STARTUPRC=${SCRDIR}/bashenv
export SINGULARITYENV_BASH_ENV=$STARTUPRC
export TERM=vt100

if [ -n "$CRAYENV_GPU_SUPPORT" ]; then
    GPUARGS="--nv --env CRAY_FTN_OPTIONS=-L/.singularity.d/libs"
else
    GPUARGS=
fi

BINDARGS="-B/glade,/var/spool/pbs,/var/run/munge,/glade/u/apps/opt/nvhpc/21.3:/opt/nvidia/hpc_sdk"
if [ ! -z "$PBS_JOBID" ] ; then
#   SCRATCH=/glade/scratch/${me}/.slurm/${PBS_JOBID}/var/tmp/$(hostname -s)
    DEB_SCRATCH=/glade/scratch/${me}/.palsd/${PBS_JOBID}/var/tmp/$(hostname -s)
    PALSETC=/glade/scratch/${me}/.palsd/${PBS_JOBID}/etc
    BINDARGS="${BINDARGS},${DEB_SCRATCH}:/tmp,${DEB_SCRATCH}:/var/run/palsd,${PALSETC}:/etc/pals"
    if [ ! -d ${DEB_SCRATCH} ] ; then
       mkdir -p ${DEB_SCRATCH}
    fi
#   ${SCRDIR}/start_slurm.sh < /dev/null
    export DEB_SCRATCH
    ${SCRDIR}/start_palsdaemons.sh < /dev/null
else
    DEB_SCRATCH=/glade/scratch/${me}
    BINDARGS="${BINDARGS},${DEB_SCRATCH}:/tmp"
fi

shargs="--rcfile ${STARTUPRC}"

ml purge
unset MODULEPATH_ROOT
unset MODULEPATH
unset MODULESHOME
unset -f module
unset -f ml

if [ $NARGS -eq 0 ] ; then
   ${SINGULARITY} run -u ${BINDARGS} ${GPUARGS} --env-file ${STARTUPENV} \
              ${SCR_IMAGEROOT} ${THESHELL} ${shargs}
else
   ${SINGULARITY} run -u ${BINDARGS} ${GPUARGS} --env-file ${STARTUPENV} \
              ${SCR_IMAGEROOT} ${THESHELL} -c "${ALLARGS}"
fi
echo "Ended: $(date +'%Y-%m-%dT%H:%M:%S')" >> ${LOGFIL}
